# 腾讯云COS存储桶公共读权限设置指南

## 🚨 重要说明

由于COS签名算法的复杂性，我们采用更简单的方案：
1. 上传文件时不设置ACL（避免签名复杂性）
2. 在存储桶级别设置公共读权限
3. 所有上传的文件自动继承存储桶的公共读权限

## 🔧 存储桶公共读权限配置

### 方法1: 通过COS控制台配置（推荐）

#### 步骤1: 登录腾讯云控制台
1. 访问 [腾讯云COS控制台](https://console.cloud.tencent.com/cos)
2. 找到您的存储桶：`itsaiagent-1303812962`

#### 步骤2: 配置存储桶访问权限
1. 点击存储桶名称进入详情页
2. 在左侧菜单中选择 **"权限管理"** > **"存储桶访问权限"**
3. 在 **"公共权限"** 部分：
   - **读权限**: 选择 **"公有读"**
   - **写权限**: 保持 **"私有写"**
4. 点击 **"保存"**

#### 步骤3: 配置存储桶策略（推荐）
1. 在左侧菜单中选择 **"权限管理"** > **"存储桶策略"**
2. 点击 **"添加策略"**
3. 选择 **"图形化策略生成器"**
4. 配置如下：
   - **效力**: 允许
   - **用户**: 所有用户（*）
   - **操作**: GetObject
   - **资源**: `audio/*` （只允许访问audio目录下的文件）
5. 点击 **"确定"** 保存

### 方法2: 使用策略语法（高级用户）

如果您熟悉策略语法，可以直接添加以下策略：

```json
{
  "version": "2.0",
  "statement": [
    {
      "principal": "*",
      "effect": "allow",
      "action": [
        "cos:GetObject"
      ],
      "resource": "qcs::cos:ap-beijing:uid/1303812962:itsaiagent-1303812962/audio/*"
    }
  ]
}
```

### 方法3: 临时测试配置

如果您只是想快速测试，可以临时设置整个存储桶为公共读：

1. 进入存储桶详情页
2. **"权限管理"** > **"存储桶访问权限"**
3. **"公共权限"** 设置为：
   - **读权限**: 公有读
   - **写权限**: 私有写

⚠️ **注意**: 这会使整个存储桶的所有文件都可公开访问，请谨慎使用。

## 🧪 验证配置

### 1. 上传测试文件

配置完成后，尝试上传一个音频文件，检查：
- 上传是否成功
- 返回的URL是否可直接访问

### 2. 直接访问测试

获得文件URL后（格式如下）：
```
https://itsaiagent-1303812962.cos.ap-beijing.myqcloud.com/audio/filename.mp3
```

在浏览器中直接访问，应该能够：
- ✅ 直接播放或下载音频文件
- ✅ 不显示权限错误
- ✅ 无需任何认证

### 3. ASR服务测试

配置完成后，测试音频总结功能：
- 上传音频文件
- 确认语音识别不再报错
- 验证完整的音频总结流程

## 🔒 安全考虑

### 1. 最小权限原则

推荐的配置只允许：
- ✅ 读取 `audio/` 目录下的文件
- ✅ 其他目录仍然是私有的
- ✅ 写权限仍然需要认证

### 2. 文件命名安全

当前的文件命名策略：
```typescript
const fileName = `audio/${nanoid()}.${fileExtension}`
```

- 使用随机ID，文件名不可预测
- 存储在专门的 `audio/` 目录
- 提供基本的安全保护

### 3. 生命周期管理

建议配置自动清理规则：
1. **"基础配置"** > **"生命周期"**
2. 添加规则：
   - **规则名称**: `audio-cleanup`
   - **作用范围**: `audio/`
   - **删除策略**: 30天后自动删除

## 🔍 故障排除

### 问题1: 配置后仍然无法访问

**可能原因**:
- 配置未生效（需要等待几分钟）
- 策略配置错误
- 文件路径不在允许范围内

**解决方案**:
1. 等待5-10分钟让配置生效
2. 检查策略中的资源路径是否正确
3. 确认文件确实在 `audio/` 目录下

### 问题2: 上传仍然失败

**可能原因**:
- 签名算法仍有问题
- 密钥配置错误

**解决方案**:
1. 运行 `npm run test:tencent` 检查基础配置
2. 检查 `TENCENT_SECRET_KEY` 长度是否正确（应该是40个字符）
3. 重新生成腾讯云API密钥

### 问题3: ASR识别仍然失败

**可能原因**:
- 存储桶权限配置未生效
- ASR服务权限不足

**解决方案**:
1. 确认文件URL可以在浏览器中直接访问
2. 运行 `npm run test:tencent-asr` 检查ASR权限
3. 检查用户是否有ASR服务权限

## 📋 配置检查清单

### 存储桶权限配置
- [ ] 设置存储桶公共读权限
- [ ] 配置存储桶策略（推荐）
- [ ] 测试文件直接访问

### 代码配置
- [ ] 简化的上传逻辑已部署
- [ ] 环境变量配置正确
- [ ] 密钥格式验证通过

### 功能测试
- [ ] 音频文件上传成功
- [ ] 返回的URL可直接访问
- [ ] ASR语音识别正常工作
- [ ] 完整音频总结流程正常

## 🎯 预期结果

配置完成后，您应该看到：

1. **上传成功日志**:
```
上传到COS: https://itsaiagent-1303812962.cos.ap-beijing.myqcloud.com/audio/xxx.mp3
使用简化签名（不设置ACL）
音频文件上传成功: https://itsaiagent-1303812962.cos.ap-beijing.myqcloud.com/audio/xxx.mp3
```

2. **ASR识别成功**:
- 不再出现"创建识别任务失败"错误
- 语音识别正常工作
- 音频总结功能完整可用

## 📞 技术支持

如果配置过程中遇到问题：

1. **运行诊断工具**:
```bash
npm run test:tencent        # 基础配置检查
npm run test:cos-upload     # COS上传测试
```

2. **检查关键配置**:
- 存储桶公共读权限是否已设置
- 存储桶策略是否正确配置
- 文件是否可以直接访问

3. **联系支持**:
- 提供完整的错误日志
- 说明已完成的配置步骤
- 提供测试结果截图

## 总结

通过在存储桶级别设置公共读权限，我们避免了复杂的文件级ACL签名问题，同时实现了音频文件的公共访问需求。这种方案：

- 🚀 **简化实现**: 避免复杂的ACL签名算法
- 🚀 **提高稳定性**: 减少签名相关的错误
- 🚀 **保持安全**: 只允许读取特定目录的文件
- 🚀 **易于维护**: 配置简单，问题排查容易

按照本指南配置后，您的音频总结功能应该可以稳定工作！
